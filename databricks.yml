bundle:
  name: retail-insight-cockpit

variables:
  catalog_name:
    description: "Unity Catalog name for retail data"
    default: "retail_analytics"

  schema_name:
    description: "Schema name for retail tables"
    default: "cockpit"

  deployment_env:
    description: "Deployment environment (dev/staging/prod)"
    default: "dev"

  warehouse_name:
    description: "SQL Warehouse name for dashboards"
    default: "retail-cockpit-dev"

targets:
  dev:
    mode: development
    workspace:
      host: https://e2-demo-field-eng.cloud.databricks.com

    variables:
      catalog_name: "retail_demo"

  staging:
    mode: production
    workspace:
      host: https://e2-demo-field-eng.cloud.databricks.com

    variables:
      catalog_name: "retail_analytics_staging"

  prod:
    mode: production
    workspace:
      host: https://e2-demo-field-eng.cloud.databricks.com

    variables:
      catalog_name: "retail_analytics"

resources:
  jobs:
    setup_retail_data:
      name: "retail-cockpit-setup-${var.deployment_env}"
      description: "Setup and initialize retail cockpit data models"

      job_clusters:
        - job_cluster_key: "main"
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "i3.xlarge"
            num_workers: 2

      tasks:
        - task_key: "setup_tables"
          job_cluster_key: "main"
          notebook_task:
            notebook_path: "./src/setup/01_create_tables.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}

        - task_key: "generate_sample_data"
          job_cluster_key: "main"
          depends_on:
            - task_key: "setup_tables"
          notebook_task:
            notebook_path: "./src/setup/02_generate_sample_data.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}

        - task_key: "create_views"
          job_cluster_key: "main"
          depends_on:
            - task_key: "generate_sample_data"
          notebook_task:
            notebook_path: "./src/setup/03_create_analytical_views.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}

        - task_key: "create_dashboards"
          job_cluster_key: "main"
          depends_on:
            - task_key: "create_views"
          notebook_task:
            notebook_path: "./src/setup/04_create_dashboards.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}
              warehouse_name: ${var.warehouse_name}

        - task_key: "setup_genie"
          job_cluster_key: "main"
          depends_on:
            - task_key: "create_dashboards"
          notebook_task:
            notebook_path: "./setup_genie.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}

    # Individual jobs for app orchestration
    create_tables_job:
      name: "Create Tables - Retail Cockpit"
      job_clusters:
        - job_cluster_key: "main_cluster"
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "i3.xlarge"
            num_workers: 1
      tasks:
        - task_key: "create_tables"
          job_cluster_key: "main_cluster"
          notebook_task:
            notebook_path: "./src/setup/01_create_tables.py"

    generate_data_job:
      name: "Generate Sample Data - Retail Cockpit"
      job_clusters:
        - job_cluster_key: "main_cluster"
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "i3.xlarge"
            num_workers: 2
      tasks:
        - task_key: "generate_data"
          job_cluster_key: "main_cluster"
          notebook_task:
            notebook_path: "./src/setup/02_generate_sample_data.py"

    create_views_job:
      name: "Create Analytical Views - Retail Cockpit"
      job_clusters:
        - job_cluster_key: "main_cluster"
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "i3.xlarge"
            num_workers: 1
      tasks:
        - task_key: "create_views"
          job_cluster_key: "main_cluster"
          notebook_task:
            notebook_path: "./src/setup/03_create_analytical_views.py"

    setup_genie_job:
      name: "Setup Genie AI - Retail Cockpit"
      job_clusters:
        - job_cluster_key: "main_cluster"
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "i3.xlarge"
            num_workers: 1
      tasks:
        - task_key: "setup_genie"
          job_cluster_key: "main_cluster"
          notebook_task:
            notebook_path: "./setup_genie.py"

    daily_refresh:
      name: "retail-cockpit-daily-refresh-${var.deployment_env}"
      description: "Daily refresh of retail analytics aggregations"

      schedule:
        quartz_cron_expression: "0 0 6 * * ?"
        timezone_id: "UTC"

      job_clusters:
        - job_cluster_key: "refresh"
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "i3.xlarge"
            num_workers: 1

      tasks:
        - task_key: "refresh_aggregations"
          job_cluster_key: "refresh"
          notebook_task:
            notebook_path: "./src/pipelines/daily_aggregations.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}


include:
  - "./config/*.yml"