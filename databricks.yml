bundle:
  name: retail-insight-cockpit
  description: "Plug-and-play retail analytics solution for Databricks Lakehouse"

variables:
  catalog_name:
    description: "Unity Catalog name for retail data"
    default: "retail_analytics"

  schema_name:
    description: "Schema name for retail tables"
    default: "cockpit"

  deployment_env:
    description: "Deployment environment (dev/staging/prod)"
    default: "dev"

targets:
  dev:
    mode: development
    workspace:
      host: https://e2-demo-field-eng.cloud.databricks.com

    variables:
      catalog_name: "retail_demo"

  staging:
    mode: production
    workspace:
      host: https://e2-demo-field-eng.cloud.databricks.com

    variables:
      catalog_name: "retail_analytics_staging"

  prod:
    mode: production
    workspace:
      host: https://e2-demo-field-eng.cloud.databricks.com

    variables:
      catalog_name: "retail_analytics"

resources:
  schemas:
    retail_cockpit_schema:
      catalog_name: ${var.catalog_name}
      name: ${var.schema_name}
      comment: "Retail Insight Cockpit schema containing all retail analytics tables"

  jobs:
    setup_retail_data:
      name: "retail-cockpit-setup-${var.deployment_env}"
      description: "Setup and initialize retail cockpit data models"

      job_clusters:
        - job_cluster_key: "main"
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "i3.xlarge"
            num_workers: 2

      tasks:
        - task_key: "setup_tables"
          job_cluster_key: "main"
          notebook_task:
            notebook_path: "./src/setup/01_create_tables.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}

        - task_key: "generate_sample_data"
          job_cluster_key: "main"
          depends_on:
            - task_key: "setup_tables"
          notebook_task:
            notebook_path: "./src/setup/02_generate_sample_data.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}

        - task_key: "create_views"
          job_cluster_key: "main"
          depends_on:
            - task_key: "generate_sample_data"
          notebook_task:
            notebook_path: "./src/setup/03_create_analytical_views.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}

    daily_refresh:
      name: "retail-cockpit-daily-refresh-${var.deployment_env}"
      description: "Daily refresh of retail analytics aggregations"

      schedule:
        quartz_cron_expression: "0 0 6 * * ?"
        timezone_id: "UTC"

      job_clusters:
        - job_cluster_key: "refresh"
          new_cluster:
            spark_version: "13.3.x-scala2.12"
            node_type_id: "i3.xlarge"
            num_workers: 1

      tasks:
        - task_key: "refresh_aggregations"
          job_cluster_key: "refresh"
          notebook_task:
            notebook_path: "./src/pipelines/daily_aggregations.py"
            base_parameters:
              catalog_name: ${var.catalog_name}
              schema_name: ${var.schema_name}

  dashboards:
    store_manager_dashboard:
      display_name: "Store Manager Cockpit - ${var.deployment_env}"
      warehouse_id: ${resources.sql_warehouse.cockpit_warehouse.id}
      serialized_dashboard: "./dashboards/store_manager_dashboard.json"

    merchandiser_dashboard:
      display_name: "Merchandiser Analytics - ${var.deployment_env}"
      warehouse_id: ${resources.sql_warehouse.cockpit_warehouse.id}
      serialized_dashboard: "./dashboards/merchandiser_dashboard.json"

    supply_chain_dashboard:
      display_name: "Supply Chain Insights - ${var.deployment_env}"
      warehouse_id: ${resources.sql_warehouse.cockpit_warehouse.id}
      serialized_dashboard: "./dashboards/supply_chain_dashboard.json"

    executive_dashboard:
      display_name: "Executive Summary - ${var.deployment_env}"
      warehouse_id: ${resources.sql_warehouse.cockpit_warehouse.id}
      serialized_dashboard: "./dashboards/executive_dashboard.json"

  sql_warehouse:
    cockpit_warehouse:
      name: "retail-cockpit-${var.deployment_env}"
      cluster_size: "Medium"
      min_num_clusters: 1
      max_num_clusters: 3
      auto_stop_mins: 60
      warehouse_type: "PRO"

  permissions:
    catalog_permissions:
      - principal: "retail_analysts"
        privileges: ["USE_CATALOG", "USE_SCHEMA", "SELECT"]
      - principal: "store_managers"
        privileges: ["USE_CATALOG", "USE_SCHEMA", "SELECT"]
      - principal: "merchandisers"
        privileges: ["USE_CATALOG", "USE_SCHEMA", "SELECT"]
      - principal: "executives"
        privileges: ["USE_CATALOG", "USE_SCHEMA", "SELECT"]

include:
  - "./config/*.yml"